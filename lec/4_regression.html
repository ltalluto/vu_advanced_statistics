<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="M. Talluto" />
  <title>Regression &amp; the Generalised Linear Model</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
            pre > code.sourceCode { white-space: pre; position: relative; }
            pre > code.sourceCode > span { line-height: 1.25; }
            pre > code.sourceCode > span:empty { height: 1.2em; }
            .sourceCode { overflow: visible; }
            code.sourceCode > span { color: inherit; text-decoration: inherit; }
            div.sourceCode { margin: 1em 0; }
            pre.sourceCode { margin: 0; }
            @media screen {
            div.sourceCode { overflow: auto; }
            }
            @media print {
            pre > code.sourceCode { white-space: pre-wrap; }
            pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
            }
            pre.numberSource code
              { counter-reset: source-line 0; }
            pre.numberSource code > span
              { position: relative; left: -4em; counter-increment: source-line; }
            pre.numberSource code > span > a:first-child::before
              { content: counter(source-line);
                position: relative; left: -1em; text-align: right; vertical-align: baseline;
                border: none; display: inline-block;
                -webkit-touch-callout: none; -webkit-user-select: none;
                -khtml-user-select: none; -moz-user-select: none;
                -ms-user-select: none; user-select: none;
                padding: 0 4px; width: 4em;
                color: #aaaaaa;
              }
            pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
            div.sourceCode
              {   }
            @media screen {
            pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
            }
            code span.al { color: #ff0000; font-weight: bold; } /* Alert */
            code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
            code span.at { color: #7d9029; } /* Attribute */
            code span.bn { color: #40a070; } /* BaseN */
            code span.bu { color: #008000; } /* BuiltIn */
            code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
            code span.ch { color: #4070a0; } /* Char */
            code span.cn { color: #880000; } /* Constant */
            code span.co { color: #60a0b0; font-style: italic; } /* Comment */
            code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
            code span.do { color: #ba2121; font-style: italic; } /* Documentation */
            code span.dt { color: #902000; } /* DataType */
            code span.dv { color: #40a070; } /* DecVal */
            code span.er { color: #ff0000; font-weight: bold; } /* Error */
            code span.ex { } /* Extension */
            code span.fl { color: #40a070; } /* Float */
            code span.fu { color: #06287e; } /* Function */
            code span.im { color: #008000; font-weight: bold; } /* Import */
            code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
            code span.kw { color: #007020; font-weight: bold; } /* Keyword */
            code span.op { color: #666666; } /* Operator */
            code span.ot { color: #007020; } /* Other */
            code span.pp { color: #bc7a00; } /* Preprocessor */
            code span.sc { color: #4070a0; } /* SpecialChar */
            code span.ss { color: #bb6688; } /* SpecialString */
            code span.st { color: #4070a0; } /* String */
            code span.va { color: #19177c; } /* Variable */
            code span.vs { color: #4070a0; } /* VerbatimString */
            code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
          </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="lib/header-attrs-2.23/header-attrs.js"></script>
  <script src="lib/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="lib/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
  <script src="lib/bootstrap-3.3.5/js/bootstrap.min.js"></script>
  <script src="lib/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
  <script src="lib/bootstrap-3.3.5/shim/respond.min.js"></script>
  <style>h1 {font-size: 34px;}
         h1.title {font-size: 38px;}
         h2 {font-size: 30px;}
         h3 {font-size: 24px;}
         h4 {font-size: 18px;}
         h5 {font-size: 16px;}
         h6 {font-size: 12px;}
         code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
         pre:not([class]) { background-color: white }</style>
  <link href="lib/slidy-2/styles/slidy.css" rel="stylesheet" />
  <script src="lib/slidy-2/scripts/slidy.js"></script>
  <script src="lib/slidy_shiny-1/slidy_shiny.js"></script>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
   href="rmd_style.css" />
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Regression &amp; the Generalised Linear Model</h1>
  <p class="author">
M. Talluto
  </p>
  <p class="date">29.11.2023</p>
</div>
<div id="regression-problems" class="slide section level2">
<h1>Regression problems</h1>
<div class="columns">
<div class="column">
<ul>
<li>Many applied problems take the form of a set of observations <span
class="math inline">\(y\)</span> along with one or more covariates <span
class="math inline">\(x\)</span></li>
<li>We want to know how <span class="math inline">\(y\)</span> changes
(on average) with <span class="math inline">\(x\)</span>, and how much
variance there is in <span class="math inline">\(y\)</span></li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-1-1.png" width="384" /></p>
</div>
</div>
</div>
<div id="regression-problems-1" class="slide section level2">
<h1>Regression problems</h1>
<div class="columns">
<div class="column">
<ul>
<li>We can draw a line through the points that minimizes the sum of
squared residuals <span class="math inline">\(\sum_i (y_i -
\mathbb{E}[y|x_i])^2\)</span></li>
<li><span class="math inline">\(\mathbb{E}[y|x_i]\)</span> is the
expectation of <span class="math inline">\(y\)</span> conditional on x
<ul>
<li>what do we expect <span class="math inline">\(y\)</span> to be, on
average, for any value of <span class="math inline">\(x\)</span></li>
</ul></li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-2-1.png" width="384" /></p>
</div>
</div>
</div>
<div id="regression-problems-2" class="slide section level2">
<h1>Regression problems</h1>
<div class="columns">
<div class="column">
<ul>
<li>We can draw a line through the points that minimizes the sum of
squared residuals <span class="math inline">\(\sum_i (y_i -
\mathbb{E}[y|x_i])^2\)</span></li>
<li><span class="math inline">\(\mathbb{E}[y|x_i]\)</span> is the
expectation of <span class="math inline">\(y\)</span> conditional on x
<ul>
<li>what do we expect <span class="math inline">\(y\)</span> to be, on
average, for any value of <span class="math inline">\(x\)</span></li>
</ul></li>
<li>This line has two parameters, an intercept <span
class="math inline">\(a\)</span> and a slope <span
class="math inline">\(b\)</span>
<ul>
<li><span class="math inline">\(\mathbb{E}(y|x_i) = a +
bx_i\)</span></li>
</ul></li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-3-1.png" width="480" /></p>
</div>
</div>
</div>
<div id="regression-problems-3" class="slide section level2">
<h1>Regression problems</h1>
<div class="columns">
<div class="column">
<ul>
<li>We can draw a line through the points that minimizes the sum of
squared residuals <span class="math inline">\(\sum_i (y_i -
\mathbb{E}[y|x_i])^2\)</span></li>
<li><span class="math inline">\(\mathbb{E}[y|x_i]\)</span> is the
expectation of <span class="math inline">\(y\)</span> conditional on x
<ul>
<li>what do we expect <span class="math inline">\(y\)</span> to be, on
average, for any value of <span class="math inline">\(x\)</span></li>
</ul></li>
<li>This line has two parameters, an intercept <span
class="math inline">\(a\)</span> and a slope <span
class="math inline">\(b\)</span>
<ul>
<li><span class="math inline">\(\mathbb{E}(y|x_i) = a +
bx_i\)</span></li>
</ul></li>
<li><span class="math inline">\(y \sim \mathcal{N}(a + bx, s)\)</span>
<ul>
<li>“y is distributed as”</li>
</ul></li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-4-1.png" width="480" /></p>
</div>
</div>
</div>
<div id="regression-problems-4" class="slide section level2">
<h1>Regression problems</h1>
<div class="columns">
<div class="column">
<ul>
<li>We can draw a line through the points that minimizes the sum of
squared residuals <span class="math inline">\(\sum_i (y_i -
\mathbb{E}[y|x_i])^2\)</span></li>
<li><span class="math inline">\(\mathbb{E}[y|x_i]\)</span> is the
expectation of <span class="math inline">\(y\)</span> conditional on x
<ul>
<li>what do we expect <span class="math inline">\(y\)</span> to be, on
average, for any value of <span class="math inline">\(x\)</span></li>
</ul></li>
<li>This line has two parameters, an intercept <span
class="math inline">\(a\)</span> and a slope <span
class="math inline">\(b\)</span>
<ul>
<li><span class="math inline">\(\mathbb{E}(y|x_i) = a +
bx_i\)</span></li>
</ul></li>
<li><span class="math inline">\(y \sim \mathcal{N}(a + bx, s)\)</span>
<ul>
<li>“y is distributed as”</li>
</ul></li>
<li>Key assumptions:
<ul>
<li><span class="math inline">\(y\)</span> is <em>iid</em></li>
<li><span class="math inline">\(y\)</span> has constant variance with
respect to <span class="math inline">\(x\)</span></li>
<li>the residuals are normally distributed (or <span
class="math inline">\(y|x\)</span> is normally distributed)</li>
</ul></li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-5-1.png" width="480" /></p>
</div>
</div>
</div>
<div id="graphing-the-model" class="slide section level2">
<h1>Graphing the model</h1>
<div class="columns">
<div class="column">
<ul>
<li>It is always a good idea to graph your model</li>
<li>The graph represents <em>knowns</em> and <em>unknowns</em> as
<strong>nodes</strong>, with relationships as
<strong>edges</strong></li>
<li>Variables (<strong>nodes</strong>) may be either <em>stochastic</em>
or <em>deterministic</em></li>
<li>Your model must estimate all unknowns
<ul>
<li><strong>stochastic unknowns</strong> are usually parameters</li>
<li><strong>deterministic unknowns</strong> must be computed somewhere
in your model</li>
<li><strong>stochastic knowns</strong> usually appear as the first
parameter is a probability statement like <code>dnorm</code></li>
</ul></li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-6-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="graphing-the-model-1" class="slide section level2">
<h1>Graphing the model</h1>
<div class="columns">
<div class="column">
<ul>
<li>Bayesian models that can be fit in Stan are <strong>directed acyclic
graphs</strong></li>
<li>Can draw them by hand, or use <code>igraph</code> and
<code>ggnetwork</code></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;igraph&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;ggnetwork&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co"># Here we define the edges</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co"># -+ is an arrow you want to draw (+ is the arrowhead)</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co"># Nodes are created implicitly; name it here and it will be added</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>gr <span class="ot">=</span> <span class="fu">graph_from_literal</span>(a<span class="sc">-+</span><span class="st">&quot;E(y)&quot;</span>, b<span class="sc">-+</span><span class="st">&quot;E(y)&quot;</span>, s<span class="sc">-+</span>y, x<span class="sc">-+</span><span class="st">&quot;E(y)&quot;</span>, <span class="st">&quot;E(y)&quot;</span><span class="sc">-+</span>y)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co"># Here we define two attributes, type and source</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co"># These are assigned to nodes using the V (for Vertex) function</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co"># The order is defined by the order the nodes appear when the graph is created</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">V</span>(gr)<span class="sc">$</span>type <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;stochastic&quot;</span>, <span class="st">&quot;deterministic&quot;</span>, <span class="st">&quot;stochastic&quot;</span>, </span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>               <span class="st">&quot;stochastic&quot;</span>, <span class="st">&quot;stochastic&quot;</span>, <span class="st">&quot;deterministic&quot;</span>)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="fu">V</span>(gr)<span class="sc">$</span>source <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;unknown&quot;</span>, <span class="st">&quot;unknown&quot;</span>, <span class="st">&quot;unknown&quot;</span>, </span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>                 <span class="st">&quot;unknown&quot;</span>, <span class="st">&quot;known&quot;</span>, <span class="st">&quot;known&quot;</span>)</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="co"># Here we define an optional layout, telling ggnetwork where to put each node</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="co"># The matrix should have one row per node, and columns are x and y coordinates</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="co"># If you skip this, ggnetwork will try to make a pretty graph by itself</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>layout <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.5</span>,<span class="dv">2</span>,  <span class="fl">0.5</span>,<span class="dv">1</span>,  <span class="dv">1</span>,<span class="dv">2</span>,  <span class="fl">1.5</span>,<span class="dv">2</span>,  <span class="fl">1.25</span>,<span class="dv">0</span>, <span class="dv">0</span>,<span class="dv">2</span>), </span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>                <span class="at">byrow=</span><span class="cn">TRUE</span>, <span class="at">ncol=</span><span class="dv">2</span>)</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">ggnetwork</span>(gr, <span class="at">layout=</span>layout)</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>(<span class="at">pl =</span> <span class="fu">ggplot</span>(n, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span> </span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>   <span class="fu">geom_edges</span>(<span class="at">colour=</span><span class="st">&quot;gray50&quot;</span>, <span class="at">arrow=</span><span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="dv">6</span>, <span class="st">&quot;pt&quot;</span>), </span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>                                <span class="at">type =</span> <span class="st">&quot;closed&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>   <span class="fu">theme_blank</span>() <span class="sc">+</span> <span class="fu">geom_nodes</span>(<span class="fu">aes</span>(<span class="at">color=</span>type, <span class="at">shape =</span> source), <span class="at">size=</span><span class="dv">6</span>) <span class="sc">+</span> </span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>   <span class="fu">geom_nodelabel</span>(<span class="fu">aes</span>(<span class="at">label =</span> name), <span class="at">fontface =</span> <span class="st">&quot;bold&quot;</span>, <span class="at">nudge_x=</span><span class="sc">-</span><span class="fl">0.1</span>))</span></code></pre></div>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-8-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="using-the-graph" class="slide section level2">
<h1>Using the graph</h1>
<div class="columns">
<div class="column">
<ul>
<li>You can use the graph to help you design your Stan code!</li>
</ul>
<ol style="list-style-type: decimal">
<li>Start with an empty model</li>
<li>Simple guideline: everything in your graph <strong>must</strong>
either:
<ul>
<li>Appear on the left side of the <code>~</code> symbol (stochastic
nodes)</li>
<li>Appear on the left side of the <code>=</code> symbol (deterministic
unknowns)</li>
<li>Appear in the <code>data</code> block (everything else)</li>
<li>Stochastic variables that are also measured will be in
<code>data</code> <strong>and</strong> on the left side of
<code>~</code><br />
</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb2"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>}</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>}</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>}</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>}</span></code></pre></div>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-10-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="using-the-graph-1" class="slide section level2">
<h1>Using the graph</h1>
<div class="columns">
<div class="column">
<ol start="3" style="list-style-type: decimal">
<li>I will start at the bottom, with <code>y</code>. I will
<strong>define</strong> the distribution of <code>y</code>.
<ul>
<li>In our graph, <code>y</code> has two dependencies (<code>eta</code>
and <code>s</code>); these should appear on the right side of the
expression for <code>y</code>.</li>
<li>I also need to <code>declare</code> the variable (i.e., tell Stan
what kind of variable <code>y</code> is)</li>
<li>Here <code>y</code> is a <strong>vector</strong>. How does this
differ from an <strong>array</strong>?</li>
<li>A <strong>vector</strong> is always a 1-dimensional sequence of real
numbers!</li>
</ul></li>
</ol>
<p>Syntax:</p>
<pre><code>| real y [n];   // array of n real numbers
| vector [n] y; // vector of n real numbers</code></pre>
<div class="sourceCode" id="cb4"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="dt">vector</span> [n] y;</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>}</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>}</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    y ~ normal(eta, s);</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>}</span></code></pre></div>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-12-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="using-the-graph-2" class="slide section level2">
<h1>Using the graph</h1>
<div class="columns">
<div class="column">
<ol start="4" style="list-style-type: decimal">
<li>Everything I used to declare/define <code>y</code> now needs it’s
own declaration and definition.
<ul>
<li>Here we do <code>s</code> and <code>n</code>, which have no
dependencies.</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb5"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; n;</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    <span class="dt">vector</span> [n] y;</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>}</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="dt">real</span> &lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; s;</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>}</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>}</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    y ~ normal(eta, s);</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>    s ~ exponential(<span class="fl">0.1</span>);</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>}</span></code></pre></div>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-14-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="using-the-graph-3" class="slide section level2">
<h1>Using the graph</h1>
<div class="columns">
<div class="column">
<ol start="5" style="list-style-type: decimal">
<li>Iterate, following each dependency until everything on the graph is
in the model</li>
</ol>
<div class="sourceCode" id="cb6"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; n;</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="dt">vector</span> [n] y;</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>}</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    <span class="dt">real</span> &lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; s;</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>}</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    <span class="dt">vector</span> [n] eta;</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    eta = a + b * x;</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>}</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    y ~ normal(eta, s);</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    s ~ exponential(<span class="fl">0.1</span>);</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>}</span></code></pre></div>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-16-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="using-the-graph-4" class="slide section level2">
<h1>Using the graph</h1>
<div class="columns">
<div class="column">
<ol start="5" style="list-style-type: decimal">
<li>Iterate, following each dependency until everything on the graph is
in the model</li>
</ol>
<div class="sourceCode" id="cb7"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; n;</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    <span class="dt">vector</span> [n] y;</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    <span class="dt">vector</span> [n] x;</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>}</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    <span class="dt">real</span> &lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; s;</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>    <span class="dt">real</span> a;</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="dt">real</span> b;</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>}</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>    <span class="dt">vector</span> [n] eta;</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>    eta = a + b * x;</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>}</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>    y ~ normal(eta, s);</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>    s ~ exponential(<span class="fl">0.1</span>);</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>    a ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>    b ~ normal(<span class="dv">0</span>, <span class="dv">5</span>);</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>}</span></code></pre></div>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-18-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="what-to-put-where" class="slide section level2">
<h1>What to put where??</h1>
<p>These are guidelines not strict rules…</p>
<div class="columns">
<div class="column">
<div class="sourceCode" id="cb8"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="co">// declaration of all knowns</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>}</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    <span class="co">// declaration of all stochastic unkowns</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>}</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    <span class="co">// declaration and definition of deterministic unknowns</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>}</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>    <span class="co">// definition of all unknowns</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>}</span></code></pre></div>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-20-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="fitting-to-the-penguins" class="slide section level2">
<h1>Fitting to the Penguins</h1>
<div class="columns">
<div class="column">
<p><img src="../assets/img/palmerpenguins.png" width="75" /> <img
src="../assets/img/culmen_depth.png" width="150" /></p>
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-21-1.png" width="528" /></p>
</div><div class="column">
<div class="sourceCode" id="cb9"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; n;</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>    <span class="dt">vector</span> [n] bill_depth;</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    <span class="dt">vector</span> [n] bill_len;</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>}</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>    <span class="dt">real</span> &lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; s;</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>    <span class="dt">real</span> a;</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>    <span class="dt">real</span> b;</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>}</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>    <span class="dt">vector</span> [n] eta;</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>    eta = a + b * bill_len;</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>}</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>    bill_depth ~ normal(eta, s);</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>    s ~ exponential(<span class="fl">0.1</span>);</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>    a ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    b ~ normal(<span class="dv">0</span>, <span class="dv">5</span>);</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
</div>
<div id="fitting-to-the-penguins-1" class="slide section level2">
<h1>Fitting to the Penguins</h1>
<div class="columns">
<div class="column">
<p><img src="../assets/img/palmerpenguins.png" width="75" /> <img
src="../assets/img/culmen_depth.png" width="150" /></p>
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-23-1.png" width="528" /></p>
</div><div class="column">
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>peng_lm <span class="ot">=</span> <span class="fu">stan_model</span>(<span class="st">&quot;stan/penguin_lm.stan&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>penguins <span class="ot">=</span> <span class="fu">as.data.frame</span>(palmerpenguins<span class="sc">::</span>penguins)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>penguins <span class="ot">=</span> <span class="fu">subset</span>(penguins, <span class="fu">complete.cases</span>(penguins) <span class="sc">&amp;</span> species <span class="sc">==</span> <span class="st">&quot;Gentoo&quot;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>peng_dat <span class="ot">=</span> <span class="fu">with</span>(penguins, <span class="fu">list</span>(</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    <span class="at">bill_len =</span> bill_length_mm,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="at">bill_depth =</span> bill_depth_mm,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">length</span>(bill_length_mm)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>))</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>peng_fit <span class="ot">=</span> <span class="fu">sampling</span>(peng_lm, <span class="at">data =</span> peng_dat, <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="fu">print</span>(peng_fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;s&quot;</span>))</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="do">## Inference for Stan model: anon_model.</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="do">## 4 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="do">## post-warmup draws per chain=1000, total post-warmup draws=4000.</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="do">##   mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="do">## a 5.10    0.03 1.06 3.08 4.37 5.09 5.80  7.16   988    1</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="do">## b 0.21    0.00 0.02 0.16 0.19 0.21 0.22  0.25   986    1</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a><span class="do">## s 0.76    0.00 0.05 0.66 0.72 0.75 0.79  0.86  1490    1</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a><span class="do">## Samples were drawn using NUTS(diag_e) at Sat Nov 18 15:05:29 2023.</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a><span class="do">## For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a><span class="do">## and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a><span class="do">## convergence, Rhat=1).</span></span></code></pre></div>
</div>
</div>
</div>
<div id="more-linear-models" class="slide section level2">
<h1>More linear models</h1>
<div class="columns">
<div class="column">
<ul>
<li>Our linear model used a single x-variable: <span
class="math inline">\(\mathbb{E}(y) = a + bx\)</span></li>
<li>It is trivial to add additional predictors to a model: <span
class="math inline">\(\mathbb{E}(y) = a + b_1x_1 + b_2x_2 + \dots +
b_nx_n\)</span></li>
</ul>
</div><div class="column">

</div>
</div>
</div>
<div id="adding-a-curve" class="slide section level2">
<h1>Adding a Curve</h1>
<div class="columns">
<div class="column">
<ul>
<li>Our linear model used a single x-variable: <span
class="math inline">\(\mathbb{E}(y) = a + bx\)</span></li>
<li>It is trivial to add additional predictors to a model: <span
class="math inline">\(\mathbb{E}(y) = a + b_1x_1 + b_2x_2 + \dots +
b_nx_n\)</span></li>
<li>One reason to do this is to add a curve: we could add a new variable
called <span class="math inline">\(x^2\)</span></li>
</ul>
<p><span class="math display">\[
\mathbb{E}(y) = a + b_1x + b_2x^2
\]</span></p>
<div class="small">
<p>Dataset: Nancy Howell (Univ. Toronto) | Measurements of the Dobe
!Kung people | Republished in <a
href="https://github.com/rmcelreath/rethinking">McElreath 2020</a></p>
<p><img src="../assets/img/kung.jpg" height="200" /> <img
src="../assets/img/rethinking.jpg" height="200" /></p>
</div>
</div><div class="column">
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>kung <span class="ot">=</span> <span class="fu">fread</span>(<span class="st">&quot;https://github.com/rmcelreath/rethinking/raw/master/data/Howell1.csv&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>(<span class="at">pl =</span> <span class="fu">ggplot</span>(<span class="at">data =</span> kung, <span class="fu">aes</span>(<span class="at">x =</span> weight, <span class="at">y =</span> height)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">col =</span> <span class="st">&quot;#555555aa&quot;</span>, <span class="at">size =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">formula =</span> y<span class="sc">~</span>x<span class="sc">+</span><span class="fu">I</span>(x<span class="sc">^</span><span class="dv">2</span>), <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="fu">theme_minimal</span>())</span></code></pre></div>
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-26-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="adding-a-curve-1" class="slide section level2">
<h1>Adding a Curve</h1>
<div class="columns">
<div class="column">
<ul>
<li>Our linear model used a single x-variable: <span
class="math inline">\(\mathbb{E}(y) = a + bx\)</span></li>
<li>It is trivial to add additional predictors to a model: <span
class="math inline">\(\mathbb{E}(y) = a + b_1x_1 + b_2x_2 + \dots +
b_nx_n\)</span></li>
<li>One reason to do this is to add a curve: we could add a new variable
called <span class="math inline">\(x^2\)</span></li>
</ul>
<p><span class="math display">\[
\mathbb{E}(y) = a + b_1x + b_2x^2
\]</span></p>
<ul>
<li>Use caution: curves can predict silly things
<ul>
<li>does it make sense that height decreases after a certain
weight?</li>
</ul></li>
<li>This is still a linear model: <span
class="math inline">\(\mathbb{E}(y)\)</span> is linear with respect to
transformations of x</li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-27-1.png" width="528" /></p>
</div>
</div>
</div>
<div id="interactions" class="slide section level2">
<h1>Interactions</h1>
<div class="columns">
<div class="column">
<ul>
<li>If we multiply predictors, we produce
<strong>interactions</strong></li>
</ul>
<p><strong>Important</strong>: Always remember main effects if including
interactions</p>
<p><span class="math display">\[
\mathbb{E}(height) = a + b_1 \times weight + b_2 \times age + b_3 \times
weight \times age
\]</span></p>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-28-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="categorical-variables" class="slide section level2">
<h1>Categorical Variables</h1>
<ul>
<li>Categorical variables also fit into this scheme</li>
<li>However, we need to consider how we want to model the categories!
<ul>
<li>Not as simple as assigning numbers to each category and creating the
model</li>
</ul></li>
</ul>
<div class="columns">
<div class="column">
<p><img src="../assets/img/palmerpenguins.png" width="75" /> <img
src="../assets/img/culmen_depth.png" width="150" /></p>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-29-1.png" width="672" /></p>
<p><span class="math display">\[
depth = a + b_1 \times length + b_2 \times species??
\]</span></p>
</div>
</div>
</div>
<div id="categorical-variables-1" class="slide section level2">
<h1>Categorical Variables</h1>
<div class="columns">
<div class="column">
<ul>
<li>Categorical variables also fit into this scheme</li>
<li>However, we need to consider how we want to model the
categories!</li>
<li>We use <strong>dummy coding</strong></li>
<li>First assign a reference category - here we will use Adelie
<ul>
<li>The intercept becomes the intercept only for this category</li>
<li>So Adelie penguins have an intercept = a</li>
</ul></li>
<li>Then create binary columns indicating the other two categories
<ul>
<li>“Intercept” for each category will be $a + $ some
<strong>offset</strong></li>
<li>E.g., for Chinstrap, the intercept is <span class="math inline">\(a
+ b_2\)</span></li>
</ul></li>
</ul>
</div><div class="column">
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>penguins<span class="sc">$</span>chinstrap <span class="ot">=</span> <span class="fu">ifelse</span>(penguins<span class="sc">$</span>species <span class="sc">==</span> <span class="st">&#39;Chinstrap&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>penguins<span class="sc">$</span>gentoo <span class="ot">=</span> <span class="fu">ifelse</span>(penguins<span class="sc">$</span>species <span class="sc">==</span> <span class="st">&#39;Gentoo&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span></code></pre></div>
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-31-1.png" width="672" /></p>
<p><span class="math display">\[
depth = a + b_1 \times length + b_2 \times chinstrap + b_3 \times gentoo
\]</span></p>
</div>
</div>
</div>
<div id="categorical-variables-2" class="slide section level2">
<h1>Categorical Variables</h1>
<div class="columns">
<div class="column">
<ul>
<li>Categorical variables also fit into this scheme</li>
<li>However, we need to consider how we want to model the
categories!</li>
<li>We use <strong>dummy coding</strong></li>
<li>First assign a reference category - here we will use Adelie
<ul>
<li>The intercept becomes the intercept only for this category</li>
<li>So Adelie penguins have an intercept = a</li>
</ul></li>
<li>Then create binary columns indicating the other two categories
<ul>
<li>“Intercept” for each category will be $a + $ some
<strong>offset</strong></li>
<li>E.g., for Chinstrap, the intercept is <span class="math inline">\(a
+ b_2\)</span></li>
</ul></li>
<li>We can use interactions to give each category it’s own slope</li>
</ul>
</div><div class="column">
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>penguins<span class="sc">$</span>chinstrap <span class="ot">=</span> <span class="fu">ifelse</span>(penguins<span class="sc">$</span>species <span class="sc">==</span> <span class="st">&#39;Chinstrap&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>penguins<span class="sc">$</span>gentoo <span class="ot">=</span> <span class="fu">ifelse</span>(penguins<span class="sc">$</span>species <span class="sc">==</span> <span class="st">&#39;Gentoo&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span></code></pre></div>
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-33-1.png" width="672" /></p>
</div>
</div>
<p><span class="math display">\[
depth = a + b_1 \times length + b_2 \times chinstrap + b_3 \times gentoo
+ b_4 \times chinstrap \times length + b_5 \times gentoo \times length
\]</span></p>
</div>
<div id="matrix-notation" class="slide section level2">
<h1>Matrix Notation</h1>
<div class="columns">
<div class="column">
<ul>
<li>Since our model is a linear system, we can use linear algebra to
describe it</li>
<li>This will greatly simplify the Stan code!</li>
<li><strong>X</strong> is a matrix of predictors, one row per
observation, one column per variable
<ul>
<li>Include transformations! If you have <span
class="math inline">\(x\)</span> and <span
class="math inline">\(x^2\)</span>, these are separate columns!</li>
<li>Dummy coded categories also get one category each
<strong>except</strong> the reference category</li>
</ul></li>
<li><strong>B</strong> is a vector of parameters, one parameter per
variable</li>
<li><strong>XB</strong> (using matrix multiplication) returns <span
class="math inline">\(b_1x_1 + b_2x_2 + \dots\)</span></li>
<li>Now you can change the predictors in your model without changing the
model code!</li>
</ul>
<p><span class="math display">\[
    \eta = \mathbb{E}(y) = a + \mathbf{XB}
\]</span></p>
</div><div class="column">
<div class="sourceCode" id="cb15"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; k; <span class="co">// number of predictor variables</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; n;</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    <span class="dt">matrix</span> [n, k] X;</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    <span class="dt">vector</span> [n] y;</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>}</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>    <span class="dt">real</span> &lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; s;</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>    <span class="dt">vector</span> [k] B;</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>}</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    <span class="dt">vector</span> eta = a + X * B;</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>}</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>    y ~ normal(eta, s);</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>    s ~ exponential(<span class="fl">0.1</span>);</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>    a ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>    B ~ normal(<span class="dv">0</span>, <span class="dv">5</span>); <span class="co">// prior here is vectorised, we use the same for each B!</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
</div>
<div id="further-generalising-our-model" class="slide section level2">
<h1>Further generalising our model</h1>
<div class="columns">
<div class="column">
<ul>
<li>A motivating example: <em>Tsuga canadensis</em> mortality in eastern
North America.
<ul>
<li>Hemlock seems to prefer moderate temperatures and high
precipitation.</li>
</ul></li>
</ul>
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation?</p>
<p>We can visualise this by computing the proportion of trees that died
in each plot.</p>
<div class="small">
<p>Dataset: <a
href="https://www.nature.com/articles/s41559-017-0182">Talluto et al
2017</a></p>
<p><img src="../assets/img/tsuga.jpg" height="350" /></p>
</div>
</div><div class="column">
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>tsuga <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="st">&quot;../vu_advstats_students/data/tsuga.rds&quot;</span>)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="fu">head</span>(tsuga[, <span class="dv">4</span><span class="sc">:</span><span class="dv">8</span>])</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="do">##   born died n annual_mean_temp tot_annual_pp</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="do">## 1    1    0 0             3.41          1085</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="do">## 2    0    3 5             3.85          1003</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="do">## 3    3    0 6             3.45          1076</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="do">## 4    1    0 3             3.62          1099</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="do">## 5    0    4 4             4.60           989</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="do">## 6    4    0 3             4.24          1116</span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>tsuga<span class="sc">$</span>mortality <span class="ot">=</span> tsuga<span class="sc">$</span>died <span class="sc">/</span> tsuga<span class="sc">$</span>n</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>(<span class="at">mort_pl =</span> <span class="fu">ggplot</span>(tsuga) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> tot_annual_pp, <span class="at">y =</span> mortality, <span class="at">size =</span> n)) <span class="sc">+</span> </span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Annual precipitation (mm)&quot;</span>) <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>    <span class="fu">scale_size_binned</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="dv">3</span>)))</span></code></pre></div>
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-35-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="mortality-in-tsuga" class="slide section level2">
<h1>Mortality in Tsuga</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation?</p>
<ul>
<li>We already used a binomial likelihood to model mortality. What if we
modify our linear model this way?
<ul>
<li>Our respnose variable is <span class="math inline">\(d\)</span>, the
number of trees dying, which must be conditioned on <span
class="math inline">\(n\)</span>, the number of trees that could
die.</li>
</ul></li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-36-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="mortality-in-tsuga-1" class="slide section level2">
<h1>Mortality in Tsuga</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation?</p>
<ul>
<li>We already used a binomial likelihood to model mortality. What if we
modify our linear model this way?
<ul>
<li>Our respnose variable is <span class="math inline">\(d\)</span>, the
number of trees dying, which must be conditioned on <span
class="math inline">\(n\)</span>, the number of trees that could
die.</li>
<li>For the binomial distribution, we already saw that <span
class="math inline">\(\mathbb{E}(d|n) = \frac{d}{n} = p\)</span>, where
<span class="math inline">\(p\)</span> is the probability of an
event</li>
</ul></li>
</ul>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-37-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="mortality-in-tsuga-graphical-model"
class="slide section level2">
<h1>Mortality in Tsuga: Graphical model</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation?</p>
<ul>
<li>We already used a binomial likelihood to model mortality. What if we
modify our linear model this way?
<ul>
<li>Our respnose variable is <span class="math inline">\(d\)</span>, the
number of trees dying, which must be conditioned on <span
class="math inline">\(n\)</span>, the number of trees that could
die.</li>
<li>For the binomial distribution, we already saw that <span
class="math inline">\(\mathbb{E}(d|n) = \frac{d}{n} = p\)</span>, where
<span class="math inline">\(p\)</span> is the probability of an
event</li>
<li>We can simply model this with a linear function as before,
right?</li>
</ul></li>
</ul>
<p><span class="math display">\[
    \begin{aligned}
        \eta_i &amp; = \mathbb{E}(d_i|n_i) = a + b \times precip_i \\
        d_i &amp; \sim  \mathrm{Binomial}(n_i, \eta_i)
    \end{aligned}
\]</span></p>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-38-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="mortality-in-tsuga-stan-code" class="slide section level2">
<h1>Mortality in Tsuga: Stan code</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation? <span class="math display">\[
    \begin{aligned}
        \eta_i &amp; = \mathbb{E}(d_i|n_i) = a + b \times precip_i \\
        d_i &amp; \sim  \mathrm{Binomial}(n_i, \eta_i)
    \end{aligned}
\]</span></p>
</div><div class="column">
<div class="sourceCode" id="cb17"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; nobs;</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>    <span class="dt">vector</span> [nobs] precip;</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; n [nobs];</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; died [nobs];</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>}</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    <span class="dt">real</span> a;</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>    <span class="dt">real</span> b;</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>}</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>    <span class="dt">vector</span> [nobs] eta = a + b * precip;</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>}</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>    died ~ binomial(n, eta);</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>    a ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>    b ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
</div>
<div id="mortality-in-tsuga-running-the-model"
class="slide section level2">
<h1>Mortality in Tsuga: Running the model</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation? <span class="math display">\[
    \begin{aligned}
        \eta_i &amp; = \mathbb{E}(d_i|n_i) = a + b \times precip_i \\
        d_i &amp; \sim  \mathrm{Binomial}(n_i, \eta_i)
    \end{aligned}
\]</span></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># drop NAs from the dataset, drop plots with no trees</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>tsuga_stan_dat <span class="ot">=</span> <span class="fu">with</span>(tsuga[n <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">complete.cases</span>(tsuga), ], <span class="fu">list</span>(</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="at">died =</span> died,</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="at">n =</span> n,</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>    <span class="at">precip =</span> tot_annual_pp</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>))</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>tsuga_stan_dat<span class="sc">$</span>nobs <span class="ot">=</span> <span class="fu">length</span>(tsuga_stan_dat<span class="sc">$</span>n)</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>tsuga_fit1 <span class="ot">=</span> <span class="fu">sampling</span>(mort_binom1, <span class="at">data =</span> tsuga_stan_dat, <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="do">## Error in eval(expr, envir, enclos) : Initialization failed.</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="do">## character(0)</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="do">## error occurred during calling the sampler; sampling not done</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>tsuga_fit1 <span class="ot">=</span> <span class="fu">sampling</span>(mort_binom1, <span class="at">data =</span> tsuga_stan_dat, <span class="at">refresh =</span> <span class="dv">0</span>, </span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>                      <span class="at">init =</span> <span class="fu">list</span>(<span class="fu">list</span>(<span class="at">a =</span> <span class="fl">0.46</span>, <span class="at">b =</span> <span class="sc">-</span><span class="fl">2.5e-4</span>)), <span class="at">chains=</span><span class="dv">1</span>)</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="do">## Warning: There were 859 divergent transitions after warmup. See</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="do">## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="do">## to find out why this is a problem and how to eliminate them.</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a><span class="do">## Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a><span class="do">## Warning: The largest R-hat is 1.19, indicating chains have not mixed.</span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a><span class="do">## Running the chains for more iterations may help. See</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a><span class="do">## https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a><span class="do">## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a><span class="do">## Running the chains for more iterations may help. See</span></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a><span class="do">## https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a><span class="do">## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a><span class="do">## Running the chains for more iterations may help. See</span></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a><span class="do">## https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-41-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="improving-the-fit" class="slide section level2">
<h1>Improving the fit</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation?</p>
<p><strong>Problem:</strong> This system cannot be linear!</p>
<p><span class="math display">\[
    \begin{aligned}
        \eta_i &amp; = \mathbb{E}(d_i|n_i) = a + b \times precip_i \\
        d_i &amp; \sim  \mathrm{Binomial}(n_i, \eta_i)
    \end{aligned}
\]</span></p>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-42-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="improving-the-fit-adding-a-link-function"
class="slide section level2">
<h1>Improving the fit: adding a link function</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation?</p>
<p><strong>Problem:</strong> This system cannot be linear!</p>
<p><strong>Solution:</strong> Transform the linear equation to fit the
response using a <strong>link function</strong></p>
<p><span class="math display">\[
    \begin{aligned}
        \eta &amp; = a + b \times precip \\
        \mathcal{f}(p) &amp; = \mathcal{f}(\mathbb{E}[d|n]) = \eta &amp;
\mathrm{or} \\
        p &amp; = \mathbb{E}[d|n] = \mathcal{f}^{-1}(\eta) \\
        d &amp; \sim  \mathrm{Binomial}(n, p)
    \end{aligned}
\]</span></p>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-43-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="improving-the-fit-adding-a-link-function-1"
class="slide section level2">
<h1>Improving the fit: adding a link function</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation?</p>
<p><strong>Problem:</strong> This system cannot be linear!</p>
<p><strong>Solution:</strong> Transform the linear equation to fit the
response using a <strong>link function</strong></p>
<p>Here we need a sigmoid function. A common one for binomial problems
is the log odds, or <strong>logit</strong> function.</p>
<p><span class="math display">\[
    \begin{aligned}
        \ln \frac{p}{1-p} &amp; = \eta = a + b \times precip \\
        p &amp; = \frac{e^{\eta}}{1 + e^{\eta}} &amp; \\
        d &amp; \sim  \mathrm{Binomial}(n, p)
    \end{aligned}
\]</span></p>
</div><div class="column">
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-44-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="improving-the-fit-stan-round-2" class="slide section level2">
<h1>Improving the fit: Stan round 2</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation? <span class="math display">\[
    \begin{aligned}
        \ln \frac{p}{1-p} &amp; = \eta = a + b \times precip \\
        p &amp; = \frac{e^{\eta}}{1 + e^{\eta}} &amp; \\
        d &amp; \sim  \mathrm{Binomial}(n, p)
    \end{aligned}
\]</span></p>
</div><div class="column">
<div class="sourceCode" id="cb19"><pre
class="sourceCode stan"><code class="sourceCode stan"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; nobs;</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>    <span class="dt">vector</span> [nobs] precip;</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">1</span>&gt; n [nobs];</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>    <span class="dt">int</span> &lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; died [nobs];</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>}</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>    <span class="dt">real</span> a;</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>    <span class="dt">real</span> b;</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>}</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>    <span class="dt">vector</span> [nobs] eta = a + b * precip;</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>    <span class="dt">vector</span> &lt;<span class="kw">lower</span> = <span class="dv">0</span>, <span class="kw">upper</span> = <span class="dv">1</span>&gt; [nobs] p = inv_logit(eta);</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>}</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>    died ~ binomial(n, p);</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>    a ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>    b ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
</div>
<div id="improving-the-fit-stan-round-2-1" class="slide section level2">
<h1>Improving the fit: Stan round 2</h1>
<div class="columns">
<div class="column">
<p><strong>Research question:</strong> Does mortality decrease with
increasing precipitation? <span class="math display">\[
    \begin{aligned}
        \ln \frac{p}{1-p} &amp; = \eta = a + b \times precip \\
        p &amp; = \frac{e^{\eta}}{1 + e^{\eta}} &amp; \\
        d &amp; \sim  \mathrm{Binomial}(n, p)
    \end{aligned}
\]</span></p>
</div><div class="column">
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>tsuga_fit2 <span class="ot">=</span> <span class="fu">sampling</span>(mort_binom2, <span class="at">data =</span> tsuga_stan_dat, <span class="at">refresh =</span> <span class="dv">0</span>)</span></code></pre></div>
<p><img src="4_regression_files/figure-slidy/unnamed-chunk-47-1.png" width="576" /></p>
</div>
</div>
</div>
<div id="the-generalised-linear-model" class="slide section level2">
<h1>The Generalised Linear Model</h1>
<p>For an observed variable <span class="math inline">\(y\)</span> and a
matrix of predictors <span
class="math inline">\(\mathbf{X}\)</span>:</p>
<ol style="list-style-type: decimal">
<li>We can define the conditional expectation of <span
class="math inline">\(y\)</span>:</li>
</ol>
<p><span class="math display">\[
    \mathbb{E}(y | \mathbf{X}) = \xi
\]</span></p>
</div>
<div id="the-generalised-linear-model-1" class="slide section level2">
<h1>The Generalised Linear Model</h1>
<p>For an observed variable <span class="math inline">\(y\)</span> and a
matrix of predictors <span
class="math inline">\(\mathbf{X}\)</span>:</p>
<ol style="list-style-type: decimal">
<li>We can define the conditional expectation of <span
class="math inline">\(y\)</span>.</li>
<li>This expectation is connected to a <strong>linear predictor</strong>
via a <strong>link function</strong> <span
class="math inline">\(\mathcal{f}\)</span>
<ul>
<li>With optional additional parameters <span
class="math inline">\(\theta_{\mathcal{f}}\)</span></li>
</ul></li>
</ol>
<p><span class="math display">\[
\begin{aligned}
    \mathbb{E}(y | \mathbf{X}) &amp; = \xi \\
    \mathcal{f}(\xi, \theta_{\mathcal{f}}) &amp; = \eta \\
    \eta &amp; = \mathbf{XB}\\
\end{aligned}
\]</span></p>
</div>
<div id="the-generalised-linear-model-2" class="slide section level2">
<h1>The Generalised Linear Model</h1>
<p>For an observed variable <span class="math inline">\(y\)</span> and a
matrix of predictors <span
class="math inline">\(\mathbf{X}\)</span>:</p>
<ol style="list-style-type: decimal">
<li>We can define the conditional expectation of <span
class="math inline">\(y\)</span>.</li>
<li>This expectation is connected to a <strong>linear predictor</strong>
via a <strong>link function</strong> <span
class="math inline">\(\mathcal{f}\)</span>
<ul>
<li>With optional additional parameters <span
class="math inline">\(\theta_{\mathcal{f}}\)</span></li>
</ul></li>
<li>Randomness in our observation of <span
class="math inline">\(y\)</span> is <strong>generated</strong> by some
<strong>distribution function</strong> <span
class="math inline">\(\mathcal{D}\)</span>
<ul>
<li><span class="math inline">\(\mathcal{D}\)</span> has optional free
parameters <span
class="math inline">\(\theta_{\mathcal{D}}\)</span></li>
<li>Often <span class="math inline">\(\theta_{\mathcal{D}}\)</span> will
include dispersion parameters</li>
</ul></li>
</ol>
<p><span class="math display">\[
\begin{aligned}
    \mathbb{E}(y | \mathbf{X}) &amp; = \xi \\
    \mathcal{f}(\xi, \theta_{\mathcal{f}}) &amp; = \eta \\
    \eta &amp; = \mathbf{XB}\\
    \\
    y &amp; \sim \mathcal{D}(\xi, \theta_{\mathcal{D}})
\end{aligned}
\]</span></p>
</div>
<div id="example-the-gaussian-model" class="slide section level2">
<h1>Example: The Gaussian model</h1>
<p>For an observed variable <span class="math inline">\(y\)</span> and a
matrix of predictors <span
class="math inline">\(\mathbf{X}\)</span>:</p>
<ol style="list-style-type: decimal">
<li>We can define the conditional expectation of <span
class="math inline">\(y\)</span>.</li>
<li>The link function is the <strong>identity function</strong>
<ul>
<li>Which has no additional parameters (<span
class="math inline">\(\theta_{\mathcal{f}} = \varnothing\)</span>)</li>
</ul></li>
<li>Randomness in our observation of <span
class="math inline">\(y\)</span> is <strong>generated</strong> by the
<strong>Gaussian</strong> (i.e., Normal) PDF
<ul>
<li>Which has the additional free standard deviation parameter <span
class="math inline">\(s\)</span>: <span
class="math inline">\(\theta_{\mathcal{D}} = \{s\}\)</span></li>
</ul></li>
</ol>
<p>This is identical to our linear model from earlier! Multiple
regression is a subset of the GLM.</p>
<p><span class="math display">\[
\begin{aligned}
    \mathbb{E}(y | \mathbf{X}) &amp; = \xi \\
    \mathcal{I}(\xi) &amp; = \eta \\
    \eta &amp; = \mathbf{XB} \\ &amp; \therefore\\
    \mathbb{E}(y | \mathbf{X}) &amp; = \mathbf{XB}\\
    \\
    y &amp; \sim \mathcal{N}(\mathbf{XB}, s)
\end{aligned}
\]</span></p>
</div>
<div id="count-data-poisson" class="slide section level2">
<h1>Count Data: Poisson</h1>
<ul>
<li>For counts where the number of trials is unkown or nonsensical,
where we speak of a rate of occurrence rather than probability
<ul>
<li>Number of species/indiviuduals in a plot</li>
<li>Incidence of a disease with an (effectively) infinite
population</li>
</ul></li>
<li>The expectation <span class="math inline">\(\lambda\)</span> is the
<strong>rate of observation</strong></li>
<li>Log link function</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\lambda &amp; = \exp(a + \mathbf{BX}) \\
y &amp; \sim \mathrm{Poisson}(\lambda)
\end{aligned}
\]</span></p>
<p><strong>Assumption:</strong> <span
class="math inline">\(\sigma^2_{y|\mathbf{X}} = \mathbb{E}(y|\mathbf{X})
= \lambda\)</span></p>
<ul>
<li>Sometimes, <em>exposure</em> varies by observation.
<ul>
<li>Different size plots</li>
<li>Different observation times</li>
<li>We add an exposure variable in this case, <strong>u</strong></li>
<li>In traditional modelling, <span class="math inline">\(\log
u\)</span> is called the <em>offset</em></li>
</ul></li>
</ul>
<p><span class="math display">\[
y \sim \mathrm{Poisson}(u\lambda)
\]</span></p>
</div>
<div id="overdispersed-counts-negative-binomial"
class="slide section level2">
<h1>Overdispersed counts: Negative Binomial</h1>
<ul>
<li>For counts where the mean and variance are not equal</li>
<li>Typical in ecological count data (e.g., abundances)</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\xi &amp; = \exp(a + \mathbf{BX}) \\
y &amp; \sim \mathrm{NB}(\xi, \phi)
\end{aligned}
\]</span></p>
<p><span class="math inline">\(\phi\)</span> is called the dispersion
parameter, and is related to the variance:</p>
<p><span class="math display">\[
\sigma^2_{y|\mathbf{X}} = \xi + \frac{\xi^2}{\phi}
\]</span></p>
</div>
<div id="proportions-beta" class="slide section level2">
<h1>Proportions: Beta</h1>
<ul>
<li>When we have true proportions (i.e., a number of trials is
unavailable)
<ul>
<li>Proportion cover</li>
</ul></li>
<li>Also used for Binomial problems where the number of trials is
missing/unrecorded</li>
<li>If number of trials is available, <strong>always</strong> prefer
Binomial GLM</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\xi &amp; = \mathrm{logit}^{-1}(a_\rho + \mathbf{B_\rho X_\rho}) \\
\phi &amp; = \exp(a_\phi + \mathbf{B_\phi X_\phi}) &amp; \mathrm{\small
optionally} \\
\alpha &amp; = \xi\phi \\
\beta &amp; = (1 - \xi)\phi \\
y &amp; \sim \mathrm{Beta}(\alpha, \beta)
\end{aligned}
\]</span></p>
<h3 id="caveats-hints">Caveats &amp; Hints</h3>
<ul>
<li><span class="math inline">\(\phi\)</span> is the
<strong>precision</strong>; <span
class="math inline">\(\sigma^2_{y|\mathbf{X}} = \frac{\xi(1-\xi)}{\phi +
1}\)</span></li>
<li>All <em>observations</em> of <span class="math inline">\(y\)</span>
must be on (0, 1). Values of exactly 0 or 1 are not allowed</li>
<li>Finite mixtures can be used if the data contain 0s and 1s.</li>
<li><span class="math inline">\(\alpha\)</span>: expected number of
successes when sampling <span class="math inline">\(\alpha +
\beta\)</span> trials</li>
<li><span class="math inline">\(\beta\)</span>: expected number of
failures</li>
</ul>
</div>
<div id="continuous-strictly-positive-gamma"
class="slide section level2">
<h1>Continuous, strictly positive: Gamma</h1>
<ul>
<li>Often used for costs, waiting times
<ul>
<li>ecosystem services modelling</li>
<li>animal movement</li>
<li>life expectancy</li>
</ul></li>
<li>Generally assume the coefficient of variation is constant
<ul>
<li>can relax this assumption by modelling <span
class="math inline">\(\phi\)</span> as a function of covariates</li>
</ul></li>
</ul>
<p><span class="math display">\[
\begin{aligned}
\xi &amp; = \frac{1}{(a + \mathbf{B X})} &amp; OR \\
\xi &amp; = \exp(a + \mathbf{B X}) \\
\\
\alpha &amp; = \frac{\xi^2}{\phi} \\ \\
\beta &amp; = \frac{\xi}{\phi} \\ \\
y &amp; \sim \mathrm{Gamma}(\alpha, \beta)
\end{aligned}
\]</span></p>
</div>

  <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>

</body>
</html>
